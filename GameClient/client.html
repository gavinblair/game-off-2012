<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WebSockets - Simple chat</title>
    </head>
    <body>
		<div  style="position:absolute;">
		<canvas id="c" width="640" height="480" style="border:1px #000 solid;"></canvas>
        </div>
		<div id="loginForm" style="position:absolute;">
			<input id="name" type="text" onClick="nameClick();" value="Enter your name."></input>
			<button id="send" onClick="sendName();">Send</button>
		</div>
		<script>
			
			function nameClick(){
				var n = document.getElementById('name');
				n.value = "";
			}
			
			var canvas = document.getElementById('c');
			var context = canvas.getContext('2d');
		
			var ss = new Image();
			ss.src = 'sheet_1.png';
		
			var ssSize = 10;
			var ssTile = new Array(6);
			ssTile[0] = { x: 0, y: 0};
			ssTile[1] = { x: 10, y: 0};
			ssTile[2] = { x: 20, y: 0};
			ssTile[3] = { x: 0, y: 10};
			ssTile[4] = { x: 10, y: 10};
			ssTile[5] = { x: 20, y: 10};
		
			var objs = [];
		
			// if user is running mozilla then use it's built-in WebSocket
			window.WebSocket = window.WebSocket || window.MozWebSocket;

			// if browser doesn't support WebSocket, just show some notification and exit
			if (!window.WebSocket) {
				console.log( 'Sorry, but your browser doesn\'t support WebSockets.');
				return;
			}

			// open connection
			var connection = new WebSocket('ws://gamedev.lab.unlab.ca:1337');

			connection.onopen = function () {
				console.log('connected!');
			};

			connection.onerror = function (error) {
				// just in there were some problems with conenction...
				console.log(error);
			};

			// most important part - incoming messages
			connection.onmessage = function (message) {
				// try to parse JSON message. Because we know that the server always returns
				// JSON this should work without any problem but we should make sure that
				// the massage is not chunked or otherwise damaged.
				try {
					var json = JSON.parse(message.data);
				} catch (e) {
					console.log('This doesn\'t look like a valid JSON: ', message.data);
					return;
				}

				// NOTE: if you're not sure about the JSON structure
				// check the server source code above
				if (json.type === 'init') {
					for(var i=0; i<json.data.length; i++)
					{
						var obj = json.data[i];
						objs.push(obj);
					}
					
					drawObjects();
				} else if (json.type === 'update') { // it's a single message
					var id = findObj(json.data.client);
					if (id == -1)
						objs.push(json.data);
					else
						objs[id] = json.data;
					
					drawObjects();
				} else if (json.type == 'remove'){
					var id = findObj(json.data);
					objs.splice(id,1);
					drawObjects();
				}else {
					console.log('Hmm..., I\'ve never seen JSON like this: ', json);
				}
			};
			
			function findObj(id)
			{
				for (var i=0; i<objs.length;i++)
				{
					if (objs[i].client == id)
						return i;
				}
				
				return -1;
			}
			
			var sp = 0;
			
			function drawObjects()
			{
				
				for (var i=0; i<objs.length; i++)
				{
					var obj = objs[i];
					
					var ssPos = ssTile[i];
					
					context.fillStyle="#FF0000";
					context.fillRect(obj.x,obj.y, ssSize, ssSize);
				}
			}
		</script>
    </body>
</html>
